Amazon Linux 2023上のEC2インスタンスでNode.js 22.13.1を使用したWebSocketサーバーを運用する際に推奨されるDeep Security (Cloud One - Workload Security) のルールについてですね。

以下に、変更監視、セキュリティログ監視、侵入防御の各モジュールで推奨されるルールカテゴリや具体的なルール例（ルール番号や名称は執筆時点での代表例であり、バージョンや環境によって異なる場合があります）、およびその選定理由をまとめます。

**重要事項:**

* **ルールIDと名称:** Trend Microはルールを頻繁に更新するため、記載されているルールIDや名称は変更される可能性があります。実際の環境でルールを検索し、内容を確認して適用してください。
* **チューニング:** 以下は一般的な推奨事項です。実際のアプリケーションの挙動や環境に合わせて、ルールの有効化/無効化や除外設定などのチューニングが必要です。誤検知が発生する場合もあります。
* **網羅性:** すべての脅威を網羅するものではありません。Deep Securityの推奨設定スキャンや、Node.js、WebSocket、Amazon Linux 2023に関連する最新の脆弱性情報に基づいて、適宜ルールを見直してください。
* **前提:** Deep Security Agentが対象のEC2インスタンスにインストールされ、Policyが適用されている状態を前提とします。

---

### 1. 変更監視ルール (Integrity Monitoring Rules)

**目的:** OS、Node.jsランタイム、アプリケーションコード、設定ファイルなど、重要なファイルやディレクトリへの不正な変更や予期せぬ変更を検知します。

| 推奨ルールカテゴリ/例                                    | ルールID例  | ルール名例                                                                 | 説明・選定理由                                                                                                                               |
| :------------------------------------------------------- | :---------- | :------------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------- |
| **OS基本ファイル監視** | 1002770     | Microsoft Windows - System file and directory changes detected             | (これはWindows例ですが) Linux向けにも同様の基盤ルールがあります。「Linux - Common critical files and directories」等の名称で存在します。OSの重要バイナリや設定ファイル (/bin, /sbin, /etc など) の変更を監視します。 |
| **OS設定ファイル監視** | (環境依存)  | Linux - Common configuration files                                           | `/etc` 配下の主要な設定ファイル (例: `passwd`, `group`, `shadow`, `sysconfig` 内ファイル, `sshd_config` 等) の変更を監視します。不正な設定変更やバックドア設置の試みを検知します。 |
| **Node.js実行ファイル/ライブラリ監視** | (カスタム推奨) | (カスタム) Node.js Runtime Files Monitoring                                | Node.jsの実行ファイル (`node`, `npm` など) や、インストールされたコアモジュール/グローバルモジュールの変更を監視します。ランタイム自体の改ざんを検知します。具体的なパスはインストール方法によります (例: `/usr/bin/node`, `/usr/local/bin/node`, `/usr/lib/node_modules` など)。 |
| **WebSocketアプリケーションコード/設定ファイル監視** | (カスタム推奨) | (カスタム) WebSocket Application Files Monitoring                          | 開発/デプロイしたWebSocketサーバーのソースコード (.jsファイルなど)、設定ファイル (config.jsonなど)、依存関係ファイル (`package.json`, `package-lock.json`) が格納されているディレクトリを監視対象とします。不正なコード改ざんや設定変更を検知します。 |
| **Webサーバー関連設定 (該当する場合)** | 1003119     | Web Server - Apache configuration file changes detected                    | もしNode.jsの前段にApacheやNginxなどのリバースプロキシを配置している場合は、それらの設定ファイルの変更も監視対象とします。直接Node.jsを公開する場合でも、関連するWebサービス設定 (例: systemdユニットファイル) を監視すると良いでしょう。 |
| **SSL/TLS証明書ファイル監視 (WSSの場合)** | (カスタム推奨) | (カスタム) SSL/TLS Certificate Files Monitoring                            | Secure WebSocket (WSS) を使用する場合、関連するSSL/TLS証明書ファイルや秘密鍵ファイルの変更を監視します。証明書の不正な置き換えや窃取の試みを検知します。 |
| **ユーザー/グループ管理ファイル** | (OS基本に含まれる場合あり) | Linux - Authentication files (`/etc/passwd`, `/etc/shadow`, etc.) | `/etc/passwd`, `/etc/group`, `/etc/shadow` などの変更を監視し、不正なユーザー追加や権限変更を検知します。                                         |

**補足:**

* Node.jsアプリケーションや証明書のパスは環境によって異なるため、**カスタムルール**を作成して正確なパスを指定することが強く推奨されます。
* `node_modules` ディレクトリは頻繁に変更される可能性があるため、そのまま監視対象にすると大量のアラートが発生する可能性があります。重要な依存関係のみ監視するか、デプロイ後の変更のみを検知するようにチューニングが必要です。

---

### 2. セキュリティログ監視ルール (Log Inspection Rules)

**目的:** OSのシステムログ、Auditログ、Node.jsアプリケーションログなどを監視し、セキュリティインシデントの兆候（不正ログイン試行、エラー、攻撃パターンなど）を検知します。

| 推奨ルールカテゴリ/例                     | ルールID例  | ルール名例                                             | 説明・選定理由                                                                                                                                                                                                                              |
| :---------------------------------------- | :---------- | :----------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **Linux OSシステムログ** | 1002869     | OS - Linux System Log Messages                         | `/var/log/messages` や `journald` などの標準的なLinuxシステムログを監視し、OSレベルの異常やエラー、セキュリティイベントを検知します。                                                                                                           |
| **認証失敗ログ** | 1002817     | OS - Linux Authentication Failure                      | SSHなどOSレベルでの認証失敗 (Failed password, Invalid userなど) を監視します。ブルートフォース攻撃の試みを検知するのに役立ちます。`/var/log/secure` や `journald` が主な監視対象です。                                                          |
| **ユーザー/グループ変更** | 1002836     | OS - Linux User Or Group Modification                  | `useradd`, `groupadd` コマンド実行などのログを監視し、不正なアカウント操作を検知します。Auditログが有効な場合はそちらも活用します。                                                                                                       |
| **Linux Auditログ (有効な場合)** | 1004382     | OS - Linux Audit Log Events                            | `auditd` サービスが有効になっている場合、システムコールやファイルアクセスなど、より詳細な監査ログを監視し、不審なアクティビティを検知します。 (例: ファイル改ざん、権限昇格の試みなど)                                                              |
| **Webサーバーエラーログ (関連する場合)** | 1003050     | Web Server - Apache Error Log Messages                 | 前段にリバースプロキシがある場合や、Node.jsがWebサーバーとしてのエラーを標準的な形式でログ出力する場合に有効です。                                                                                                                            |
| **Node.jsアプリケーションログ** | (カスタム必須) | (カスタム) Node.js Application Specific Events         | **非常に重要:** Node.jsアプリケーションが出力するログ (接続試行、認証成功/失敗、エラー、予期せぬリクエスト、WebSocket固有のエラーなど) を監視するための**カスタムルール**を作成します。アプリケーション側で適切なログ出力を行うことが前提です。WebSocketの接続拒否、不正なメッセージフォーマット、レートリミット超過などを検知できるように設計します。 |
| **一般的な攻撃検知** | 1000016     | System - Generic Pattern Match                       | ログ全体から特定の攻撃パターンやキーワード (例: 'attack', 'malware', 'exploit') を検出する汎用ルール。誤検知の可能性もあるため注意が必要です。                                                                                             |
| **SSH関連イベント** | 1002818     | OS - Linux SSH Connection Accepted                     | SSH接続成功のログを監視します。通常運用外の接続元や時間帯からの接続がないか確認するのに役立ちます。                                                                                                                                         |

**補足:**

* Node.jsアプリケーションのログ監視は、アプリケーションのログフォーマットに合わせて**カスタムルールを作成することが必須**です。JSON形式でログ出力するなど、Deep Securityで解析しやすい形式にすると効果的です。
* Amazon Linux 2023では `journald` が標準的なログ管理システムです。Deep Security Agentが `journald` からログを収集するように設定されているか確認してください。

---

### 3. 侵入防御ルール (Intrusion Prevention Rules)

**目的:** ネットワークトラフィックを検査し、既知の脆弱性を悪用する攻撃、不正な通信、マルウェアの通信などを検知・防御します。WebSocket通信自体と、その基盤となるHTTP/TCP通信の両方を保護します。

| 推奨ルールカテゴリ/例                                 | ルールID例  | ルール名例                                                              | 説明・選定理由                                                                                                                                                                                          |
| :---------------------------------------------------- | :---------- | :---------------------------------------------------------------------- | :------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| **OS脆弱性対策 (Linux全般)** | (多数存在)  | Linux Kernel vulnerabilities, glibc vulnerabilities etc.                  | Amazon Linux 2023のカーネルや主要なライブラリ (glibcなど) の既知の脆弱性を悪用する攻撃を検知・防御します。Deep Securityが自動推奨するルールを適用するのが基本です。                                          |
| **Webサーバー/アプリケーション共通の脆弱性対策** | (多数存在)  | HTTP Protocol Decoding, SQL Injection, Cross-Site Scripting (XSS) etc. | WebSocketはHTTP/HTTPS上でハンドシェイクを行うため、ハンドシェイク時のリクエストに含まれる可能性のある一般的なWebアプリケーション攻撃 (SQLi, XSSなど) を検知します。WebSocket通信確立後も、メッセージ内容によっては関連する場合があります。 |
| **Node.js固有の脆弱性対策** | (要確認)    | Node.js specific vulnerabilities (例: CVE-YYYY-NNNNN)                 | Trend MicroがNode.jsランタイム自体の既知の脆弱性に対応するルールを提供している場合があります。Deep Securityのルールリストで "Node.js" を検索し、関連するCVEに対応するルールを有効化します。 **(最新のNode.jsバージョンを使うことが根本対策としても重要です)** |
| **WebSocketプロトコル関連** | (要確認)    | WebSocket Protocol Anomalies, Cross-Site WebSocket Hijacking (CSWH) related | WebSocketプロトコルの異常 (不正なフレーム、仕様違反など) や、CSWHのようなWebSocket特有の攻撃に関連するシグネチャがあれば有効化します。Deep Securityのルールリストで "WebSocket" を検索してください。 |
| **偵察行為の検知** | 1000589     | Reconnaissance - Network or Port Scan                                   | ポートスキャンやネットワークスキャンなどの攻撃の初期段階である偵察行為を検知します。                                                                                                                          |
| **ネットワークプロトコル異常検知** | 1000003     | Network Protocol - Invalid TCP Flags                                  | 不正なTCPフラグを持つパケットなど、プロトコルレベルでの異常な通信を検知します。                                                                                                                            |
| **汎用的な攻撃パターン (Exploit Kitsなど)** | (多数存在)  | Generic Exploit Patterns, Malware download attempts                   | 特定の脆弱性に限らず、既知の攻撃ツールキットやマルウェア配布サイトへの通信パターンなどを検知します。                                                                                                          |
| **Webサーバー関連 (Nginx/Apacheなど、該当する場合)** | (多数存在)  | Apache Struts vulnerabilities, Nginx specific vulnerabilities         | 前段にリバースプロキシがある場合、そのソフトウェアの脆弱性に対応するルールを有効化します。                                                                                                                      |

**補足:**

* **仮想パッチ:** 侵入防御ルールは「仮想パッチ」として機能し、OSやアプリケーションにパッチが適用されるまでの間、脆弱性を悪用する攻撃から保護するのに役立ちます。
* **パフォーマンス:** 有効にするルールが多いほど、インスタンスのパフォーマンスに影響を与える可能性があります。必要なルールに絞り込み、影響を監視することが重要です。
* **HTTPS/WSS:** 通信がTLS/SSLで暗号化されている場合、Deep Securityがトラフィックを復号して検査できるように設定する必要があります（ポート設定、証明書のインポートなど）。ただし、復号にはパフォーマンス影響やプライバシー上の考慮事項があります。ハンドシェイク部分や暗号化されていない通信に対する保護は復号なしでも機能します。
* **推奨設定のスキャン:** Deep Securityの管理コンソールから「推奨設定のスキャン」を実行すると、OSやインストールされているソフトウェアに基づいて推奨される侵入防御ルールを提示してくれます。これをベースに選定するのが効率的です。

---

**まとめと追加の考慮事項:**

1.  **ルールは最新に保つ:** Trend Microから新しいルールやアップデートが提供されるため、定期的に更新を適用してください。
2.  **テストとチューニング:** 本番適用前にステージング環境などでルールを適用し、アプリケーションの正常な動作を妨げないか、誤検知が多くないかを確認・調整してください。
3.  **カスタムルールの活用:** 特に変更監視とログ監視では、アプリケーション固有のファイルパスやログ形式に合わせてカスタムルールを作成することが効果を高める鍵となります。
4.  **他のセキュリティ対策との連携:** Deep Securityはホストベースのセキュリティを提供しますが、AWSのセキュリティグループ（ファイアウォール）、Network ACL、IAMによる適切な権限管理、OSやNode.jsの定期的なアップデートなど、他のセキュリティ対策と組み合わせることが重要です。
5.  **アプリケーションレベルのセキュリティ:** WebSocketサーバー自体のコードにセキュリティ対策（入力検証、認証・認可、レートリミット、エラーハンドリングなど）を実装することも不可欠です。Deep Securityはそれを補完する役割を担います。

上記リストを参考に、お使いのDeep Security (Cloud One) の管理コンソールで具体的なルールを検索・確認し、環境に合わせて適用・調整を進めてください。
