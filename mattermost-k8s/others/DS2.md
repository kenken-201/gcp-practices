# Amazon Linux 2023上のNode.js WebSocketサーバーにおけるTrend Micro Cloud One - Workload Security 推奨ルール選定レポート

## はじめに

### 目的の再確認

本レポートは、Amazon Linux 2023 (AL2023) を実行するAWS EC2インスタンス上で構築されたNode.js (バージョン **22.13.1**) ベースのWebSocketサーバーを保護するために、Trend Micro Cloud One - Workload Security (旧Deep Security、以下 Workload Security) で適用すべき推奨セキュリティルールを特定し、包括的なリストを提供することを目的とします。対象となるセキュリティ機能は、**変更監視 (Integrity Monitoring - IM)**、**セキュリティログ監視 (Log Inspection - LI)**、および**侵入防御 (Intrusion Prevention - IPS)** です。

### 利用者からの要求

利用者からの「漏らさず選定して一覧化していただきたい」という要求に応えるため、Workload Securityの標準機能である推奨設定スキャンを基盤としつつ、Linuxオペレーティングシステム、Node.jsランタイム、およびWebSocketプロトコルの特性を考慮したベースラインルールとカスタムルールの考え方を組み合わせ、実用的な推奨事項を提示します。

### 対象環境の特定

本レポートで対象とする環境は以下の通りです。

* **オペレーティングシステム:** Amazon Linux 2023
* **プラットフォーム:** AWS EC2
* **アプリケーションランタイム:** Node.js v22.13.1
* **主要プロトコル:** WebSocket
* **セキュリティ製品:** Trend Micro Cloud One - Workload Security

### アプローチの概要

ルール選定にあたっては、以下のステップに基づき、最適なセキュリティ体制の構築を目指します。

1.  Workload SecurityのAmazon Linux 2023に対する互換性とサポート状況を確認します。
2.  Workload Securityの「推奨設定スキャン」機能を活用し、対象環境に合わせたベースラインルールを特定します。
3.  推奨設定スキャンでカバーされない、あるいはより強化が必要な領域について、Linux OS、Node.js、WebSocketの特性に基づき、変更監視、セキュリティログ監視、侵入防御の各機能で必要となる追加ルールやカスタムルールの設定方針を提示します。
4.  特定されたルールについて、ルールID（判明している場合）、ルール名、簡単な説明、選定理由、および運用上の注意点を整理します。
5.  パフォーマンスへの影響や誤検知の可能性を考慮した、ルールの適用と運用に関するベストプラクティスを提示します。

## 推奨ルール選定の前提条件とアプローチ

### Amazon Linux 2023 サポートの確認

Workload Security Agent (旧Deep Security Agent) は、バージョン **20.0.0-7303** (20 LTS Update 2023-06-28) 以降で、Amazon Linux 2023 (x86_64 アーキテクチャおよび AWS Graviton2 Armベースアーキテクチャの両方) を正式にサポートしています (1)。これには、Workload Security Manager (旧Deep Security Manager) バージョン **20.0.789** 以降が必要です (1)。

Amazon Linux 2023は比較的新しいディストリビューションであり、2023年半ばにWorkload Securityのサポートが追加されました。そのため、使用するエージェントおよびマネージャーのバージョンが、これらの要件を満たしていることを確認することが極めて重要です。古いバージョンのコンポーネントを使用している場合、予期せぬ動作や保護機能の制限が発生する可能性があります。また、FIPS 140-2準拠モードでの利用もサポートされていますが、Amazon Linux 2023自体のFIPS認定状況については、別途AWSの公式情報を参照する必要があります (2)。

### 推奨設定スキャンの活用

Workload Securityは、保護対象のコンピュータをスキャンし、そのOS、インストールされているアプリケーション、および現在の構成に基づいて、適用が推奨される侵入防御(IPS)、変更監視(IM)、セキュリティログ監視(LI)ルールを自動的に提案する**「推奨設定スキャン」**機能を提供します (1)。

特に、Linux環境、Node.jsアプリケーション、WebSocket通信に特化した、すぐに利用可能な事前定義されたルールセットに関する具体的な情報は、提供された資料からは限定的でした (4)。この状況は、Trend Microが多様なLinux環境やカスタムアプリケーションに対して、静的な推奨リストを提供するよりも、個々の環境に合わせて動的にルールを提案する推奨設定スキャンや、ユーザーによるカスタマイズを主要な設定アプローチとして位置づけていることを示唆しています。したがって、**推奨設定スキャンは、本環境におけるセキュリティルール選定の不可欠な出発点**となります。

推奨設定スキャンの結果を最大限に活用するためには、スキャンを実行するタイミングが重要です。OSインストール直後ではなく、**Node.jsランタイム、依存モジュール、およびWebSocketサーバーアプリケーションが実際にデプロイされ、稼働している状態のインスタンスに対してスキャンを実行する**ことが推奨されます。これにより、アプリケーション固有のコンポーネントや動作パターンを考慮した、より精度の高いルール推奨が期待できます (6)。推奨設定スキャンの結果は、そのまま適用するだけでなく、内容を評価し、必要に応じて調整することが重要です。

### ベースラインルールの考え方

推奨設定スキャンは強力な機能ですが、それだけではカバーしきれない、あるいは組織のセキュリティポリシー上、より明示的な監視が必要となる場合があります。例えば、特定の重要な設定ファイルや、カスタムアプリケーション固有のログイベントなどが該当します。

このような場合、Workload Securityが提供するルールテンプレート（変更監視用: `File`テンプレート、`DirectorySet`エンティティなど (4)、セキュリティログ監視用: `Basic`テンプレート、XMLベース定義 (8)）や、ルール定義言語 (4) を用いて、**カスタムルールを作成する**必要があります。

本レポートでは、推奨設定スキャンを補完する形で、一般的なLinuxシステム管理、Node.jsアプリケーション、WebSocket通信の保護において、基本として考慮すべき監視対象や検知イベントを特定し、それらを実現するためのカスタムルールの作成方針を示します。

### パフォーマンスと誤検知に関する考慮事項

セキュリティルール、特に侵入防御(IPS)ルールは、ネットワークトラフィックの詳細な検査を行うため、多数のルールを有効化すると、サーバーのCPUやメモリリソースを消費し、パフォーマンスに影響を与える可能性があります (1)。同様に、変更監視(IM)ルールやセキュリティログ監視(LI)ルールも、監視対象の範囲や設定内容によっては、大量のイベントログを生成し、システムのパフォーマンス低下や、実際には問題ない変更やログエントリを脅威として検知してしまう**「誤検知（False Positive）」**を引き起こす可能性があります (8)。

「漏らさず」という網羅性の要求と、実運用におけるパフォーマンスや誤検知のリスクとの間には、**トレードオフ**が存在します。したがって、ルールの適用にあたっては、以下の点を考慮することが推奨されます。

* **段階的な適用:** 一度に全てのルールを有効にするのではなく、重要度の高いルールから段階的に適用し、影響を確認します。
* **Detectモードの活用:** 特に新しいカスタムルールや、影響範囲の広いIPSルールカテゴリについては、即座に通信をブロックする「Preventモード」ではなく、まずは検知のみを行う「Detectモード」で運用を開始し、一定期間の監視を通じて誤検知が発生しないか、パフォーマンスへの影響が許容範囲内かを確認します (11)。
* **チューニング:** 誤検知が発生した場合は、ルールの除外設定や条件を調整します。パフォーマンスへの影響が大きい場合は、ルールの見直しや、より効率的な監視方法を検討します。

## 変更監視 (Integrity Monitoring - IM) 推奨ルール

### 目的

変更監視(IM)機能の主な目的は、OSの重要な設定ファイル、システムバイナリ、Node.jsランタイム、依存関係にあるライブラリ、WebSocketサーバーのアプリケーションコード、設定ファイルなど、システムの整合性に関わる重要なコンポーネントに対する不正または予期せぬ変更をリアルタイムまたはスケジュールベースで検知することです。これにより、マルウェアの潜伏、設定ミス、不正な改ざんなどを早期に発見し、対応することが可能になります。また、PCI DSSなどのコンプライアンス要件では、重要なシステムファイルの変更監視が求められており、IM機能はその要件充足にも貢献します (3)。

### アプローチ

1.  **推奨設定スキャンの実行:** まず、対象のEC2インスタンス（Node.js WebSocketサーバー稼働状態）に対して推奨設定スキャンを実行し、Workload Securityが提案するIMルールを確認します (6)。提案されたルールが適切であれば、それを適用します。
2.  **カスタムルールの作成:** 推奨設定スキャンで提案されなかった、あるいは組織のポリシーとして明示的に監視が必要な対象については、カスタムルールを作成します。Workload Securityは、ファイルやディレクトリ、レジストリ（Windowsの場合）、インストール済みソフトウェア、プロセス、サービスなどを監視するためのテンプレートやルール言語を提供しています (4)。Linux環境では主に**`File`テンプレート**や**`DirectorySet`エンティティ**、場合によっては`ProcessSet`などが利用されます (7)。

### Linuxベースライン推奨ルール

提供された資料からは、Amazon Linux 2023を含むLinuxシステム向けの具体的なデフォルトIMルールリストは確認できませんでした (4)。これは、Linuxディストリビューションや用途による構成の違いが大きいため、画一的な推奨が難しいことを反映していると考えられます。したがって、推奨設定スキャンの結果を尊重しつつ、以下の一般的な監視対象を参考に、必要に応じてカスタムルールを作成・追加することが推奨されます。

#### 推奨監視対象（例）:

* **システム設定ファイル:** `/etc/passwd`, `/etc/shadow`, `/etc/group`, `/etc/gshadow`, `/etc/sudoers`, `/etc/ssh/sshd_config`, `/etc/sysctl.conf`, `/etc/hosts`, `/etc/resolv.conf` など。
* **ブート関連ファイル:** `/boot/` 配下のブートローダー設定ファイル (例: GRUB設定)。
* **システムバイナリ:** `/usr/bin/`, `/usr/sbin/`, `/bin/`, `/sbin/` 配下の実行ファイル。
* **システムライブラリ:** `/lib/`, `/usr/lib/`, `/lib64/`, `/usr/lib64/` 配下の共有ライブラリ。
* **カーネルモジュール:** `/lib/modules/` 配下のカーネルモジュール。
* **システムサービス設定:** systemdのユニットファイル (`/etc/systemd/system/`, `/usr/lib/systemd/system/` 配下)。
* **ログファイル自体の変更:** `/var/log/` 配下のログファイル自体の改ざん（ログローテーションによる正常な変更は除外対象とすることが多い）。

#### 設定方法:

Workload Securityのポリシー設定画面から、「変更監視」>「ルール」へ進み、「新規」>「新規の変更監視ルール」を選択します。「`File`」テンプレートを使用し、監視対象のファイルパスやディレクトリパスを指定します。監視する属性（作成、変更、削除、属性変更など）を選択し、必要に応じて除外ルール（特定のサブディレクトリやファイルパターンを除外するなど）を設定します。

### Node.jsおよびWebSocketアプリケーション固有の推奨ルール

Node.jsアプリケーションとWebSocketサーバーに関連するファイルも、システムの整合性を保つ上で重要な監視対象です。

#### 推奨監視対象（例）:

* **Node.js実行ファイル:** `node` コマンドのパス (例: `which node` で確認したパス、`/usr/bin/node` や `/opt/node/bin/node` など)。
* **npm/yarn関連ファイル:** グローバルにインストールされたパッケージ管理ツールの重要なファイル。
* **プロジェクト依存関係:** プロジェクトルートの `node_modules/` ディレクトリ。**ただし、このディレクトリは `npm install` や `npm update` で頻繁に変更されるため、そのまま監視すると大量のイベントが発生し、パフォーマンスに影響を与える可能性があります。**対策として、特に重要なライブラリのディレクトリのみを監視対象とする、変更が想定される期間（デプロイ時など）は一時的に監視を無効化する、ベースラインの再構築を頻繁に行う、などの運用上の工夫が必要です。
* **アプリケーションコード:** WebSocketサーバーの実装ファイル (例: `server.js`, `app.js`, `websocketHandler.js` など)。
* **設定ファイル:** アプリケーション固有の設定ファイル (例: `.env`, `config.json`, `settings.yaml` など)。
* **依存関係定義ファイル:** `package.json`, `package-lock.json` (または `yarn.lock`)。これらのファイルの変更は、意図しないライブラリの導入やバージョンダウン/アップグレードを示す可能性があるため、監視が推奨されます。

#### 設定方法:

Linuxベースラインと同様に、「`File`」テンプレートや「`DirectorySet`」を使用してカスタムルールを作成します。`node_modules` の監視については、前述の注意点を考慮し、監視範囲や運用方法を慎重に決定してください。

### 表1: 推奨変更監視ルールリスト

以下の表は、推奨される変更監視ルールの例を示します。実際のルールIDは推奨設定スキャンやWorkload Security内のルールライブラリで確認するか、カスタムルールとして作成してください。パスは環境に合わせて修正が必要です。

| ルールID               | ルール名                                     | 監視対象・説明                                                            | 監視属性                       | 選定理由                       | 注意点                                                      |
| :--------------------- | :------------------------------------------- | :------------------------------------------------------------------------ | :----------------------------- | :----------------------------- | :---------------------------------------------------------- |
| 推奨スキャン結果       | (スキャン結果に基づく)                       | (スキャン結果に基づく)                                                    | (スキャン結果に基づく)         | OS/アプリ構成に基づく推奨      | スキャン結果を評価・調整                                    |
| カスタム               | Linux - Monitor Critical Config Files        | `/etc/passwd`, `/etc/shadow`, `/etc/sudoers`, `/etc/ssh/sshd_config`       | 変更, 削除, 属性変更           | 重要システム設定ファイルの保護 | パス、属性は要件に応じて調整                                |
| カスタム               | Linux - Monitor System Binaries              | `/usr/bin/`, `/usr/sbin/`, `/bin/`, `/sbin/`                             | 作成, 変更, 削除               | 不正なコマンド設置・改ざん検知 | パフォーマンス影響を考慮し範囲を検討                        |
| カスタム               | Linux - Monitor System Libraries             | `/lib/`, `/usr/lib/`, `/lib64/`, `/usr/lib64/`                           | 作成, 変更, 削除               | 不正なライブラリ導入・改ざん検知 | パフォーマンス影響を考慮し範囲を検討                        |
| カスタム               | NodeJS - Monitor Runtime                     | `/usr/bin/node` (環境依存)                                                | 変更, 削除                     | Node.jsランタイム自体の改ざん検知 | 正確なパスを指定                                            |
| カスタム               | NodeJS - Monitor Package Definitions         | `/path/to/app/package.json`, `/path/to/app/package-lock.json`             | 変更, 削除                     | 依存関係の不正な変更検知       | アプリケーションルートパスを指定                            |
| カスタム               | WebSocketApp - Monitor App Code              | `/path/to/app/server.js`, `/path/to/app/lib/`                             | 変更, 削除                     | アプリケーションコードの改ざん検知 | 主要なコードファイル/ディレクトリを指定                     |
| カスタム               | WebSocketApp - Monitor Config File           | `/path/to/app/config.json`, `/path/to/app/.env`                           | 変更, 削除                     | アプリケーション設定の不正な変更検知 | 設定ファイルのパスを指定                                    |
| カスタム               | NodeJS - Monitor Critical node_modules       | `/path/to/app/node_modules/important-lib/`                                | 作成, 変更, 削除               | 特定の重要ライブラリの変更検知 | `node_modules`全体監視は非推奨。対象を絞る                |

## セキュリティログ監視 (Log Inspection - LI) 推奨ルール

### 目的

セキュリティログ監視(LI)機能は、OSやアプリケーションが生成するログファイルを監視し、定義されたパターンやルールに一致するイベントを検知することを目的とします (8)。これにより、不正アクセス試行、システムエラー、設定変更、マルウェア活動の兆候、ポリシー違反など、セキュリティインシデントを示唆する可能性のあるログエントリをリアルタイムに近い形で特定し、アラート通知やSIEM連携による迅速な調査・対応を支援します。

### アプローチ

1.  **推奨設定スキャンの実行:** 変更監視(IM)と同様に、まず推奨設定スキャンを実行し、対象システムとアプリケーションに基づいて提案されるLIルールを確認・適用します (6)。Workload Securityには、多くの一般的なOSログやアプリケーションログ（Apache, Syslogなど）に対応する事前定義ルールが含まれている可能性があります。
2.  **既存ルールの確認と有効化:** Workload Securityコンソールの「ポリシー」>「共通オブジェクト」>「ルール」>「セキュリティログ監視ルール」で、利用可能なルールを確認します。特に、Linux OSやSyslogに関連するルールが存在する場合は、内容を確認し、有効化を検討します。
3.  **カスタムルールの作成:** 推奨設定スキャンや既存ルールでカバーされないログ（特にカスタムアプリケーションログ）や、特定の検知要件がある場合は、カスタムLIルールを作成します。Workload Securityでは、基本的な文字列マッチングや正規表現を用いたパターン定義、あるいはより複雑なロジックを記述できる**XMLベースのルール定義**が可能です (8)。

### Linuxベースライン推奨ルール

Linuxシステムにおける標準的なログファイルは、セキュリティ監視において非常に重要です。提供された資料には具体的なLinuxベースラインLIルールリストは含まれていませんでしたが (9)、推奨設定スキャンやWorkload Security内のルールライブラリを確認し、以下のログファイルとイベントタイプに対する監視ルールが存在するか確認し、なければカスタムルールとして作成することを推奨します。

#### 推奨監視対象ログとイベント（例）:

* **/var/log/secure** (または `auth.log`, journaldの同等ログ):
    * SSHログイン失敗 (特に短時間に繰り返される場合)
    * SSHログイン成功 (特にrootユーザーや予期しないユーザー/IPから)
    * `su` または `sudo` による特権昇格の試行 (成功/失敗)
    * ユーザーアカウントの作成、削除、変更、ロック
    * グループメンバーシップの変更
* **/var/log/messages** (または `syslog`, journald):
    * システムの起動、シャットダウン
    * 重要なサービスの開始、停止、再起動の失敗
    * カーネルレベルのエラー、警告 (OOM Killerなど)
    * ハードウェアエラー
    * ネットワークインターフェースのダウン/アップ
* **/var/log/audit/audit.log** (auditdサービスが有効な場合):
    * 重要な設定ファイル (例: `/etc/passwd`, `/etc/shadow`) へのアクセス、変更試行
    * システムコールの異常な使用 (特定の攻撃を示唆する可能性のあるもの)
    * SELinux または AppArmor のポリシー違反イベント
    * **注意:** `auditd`ログは非常に詳細で冗長になる可能性があるため、監視対象とするイベントタイプ (auditctlルール) を慎重に選択し、LIルールも必要なイベントのみを拾うようにチューニングする必要があります。
* **その他のログ:**
    * `cron` のジョブ実行エラー (`/var/log/cron`)
    * パッケージマネージャー (yum, dnf, rpm) によるソフトウェアのインストール、アップデート、削除 (`/var/log/yum.log` など)

#### 設定方法:

Workload Securityのポリシー設定画面から、「セキュリティログ監視」>「ルール」へ進み、既存ルールを検索・有効化するか、「新規」>「新規のセキュリティログ監視ルール」を選択します。ルールエディタで、監視対象ログファイルのパス、ログフォーマット（例: "Syslog"）、検知したいログエントリのパターン（単純な文字列、正規表現、またはXML定義）を指定します。イベントの重要度（Severity）やアラート設定も構成します。

### Node.jsおよびWebSocketアプリケーション固有の推奨ルール

Node.jsアプリケーションやWebSocketサーバーが出力するログは、アプリケーション固有の挙動や問題を把握するために重要です。しかし、ログの内容やフォーマットは標準化されておらず、アプリケーションの実装に大きく依存します。そのため、汎用的な事前定義ルールは限定的であり、効果的な監視のためには**カスタムルール作成がほぼ必須**となります。

最も効果的なアプローチは、アプリケーション開発チームと連携し、以下のようなセキュリティ上重要なイベントが、解析可能な形式（例: JSON）でログに出力されるようにアプリケーションを実装し、それらのログエントリを検知するカスタムLIルールを作成することです。

#### 推奨監視対象イベント（例）:

* **アプリケーションエラー:**
    * Node.jsプロセスにおける未捕捉の例外 (`uncaughtException`)
    * 処理されなかったPromiseの拒否 (`unhandledRejection`)
    * アプリケーションロジック内の特定のエラーコードやメッセージ (例: "Database connection failed", "Critical configuration missing")
* **認証・認可イベント:**
    * WebSocket接続時の認証試行（成功/失敗）
    * APIエンドポイントへのアクセスにおける認証/認可エラー (401 Unauthorized, 403 Forbidden)
    * パスワードリセット、アカウントロックアウトなどのセキュリティ関連操作
* **入力バリデーション違反:**
    * 予期しない入力データ、不正な形式のリクエスト
    * 潜在的なインジェクション攻撃を示唆する入力パターン (SQLi, XSS, コマンドインジェクションの兆候)
* **リソース関連イベント:**
    * レートリミット超過の警告やエラー
    * データベース接続プール枯渇、メモリ使用量の高騰など、リソース不足を示唆するログ
* **WebSocket固有イベント:**
    * WebSocketハンドシェイクの失敗
    * 予期しないクライアントからの接続試行
    * 大量のメッセージ送信や異常なサイズのフレーム受信 (DoSの可能性)

#### 設定方法:

Node.jsアプリケーションがログを出力するファイルのパスとフォーマット（プレーンテキスト、JSONなど）を確認します。LIルールエディタで、ログファイルのパスとフォーマットを指定し、検知したいイベントに対応するパターン（正規表現やXMLクエリ）を定義します。JSON形式のログであれば、特定のキーとその値に基づいてイベントを検知するルールを作成できます。

### 表2: 推奨セキュリティログ監視ルールリスト

以下の表は、推奨されるセキュリティログ監視ルールの例を示します。ルールIDはWorkload Security内の既存ルールを確認するか、カスタムルールとして作成します。

| ルールID         | ルール名                                     | 監視対象ログ・説明                    | 検知パターン・イベント例                                                   | 選定理由                       | 注意点                                               |
| :--------------- | :------------------------------------------- | :------------------------------------ | :------------------------------------------------------------------------- | :----------------------------- | :--------------------------------------------------- |
| (要確認)         | Linux - SSH Login Failures                   | `/var/log/secure` または同等          | `"Failed password for"`, `"Maximum authentication attempts exceeded"`      | 不正アクセス試行検知           | しきい値設定で過剰アラート抑制                         |
| (要確認)         | Linux - Successful Root Login                | `/var/log/secure` または同等          | `"Accepted password/publickey for root"`, `"session opened for user root"` | 特権アカウントの不正使用検知   | 正当なrootログインとの区別が必要                     |
| (要確認)         | Linux - Sudo Usage                           | `/var/log/secure` または同等          | `"sudo:... COMMAND=..."`                                                 | 特権操作の監査               | 必要に応じて実行ユーザー/コマンドで絞込              |
| (要確認)         | Linux - System Service Failure               | `/var/log/messages` または同等        | `"service... failed"`, `"Stopped target..."`, `"kernel:.*error"`           | システム/サービスの安定性監視  | 正常な停止/再起動との区別                          |
| カスタム         | Linux - Critical File Access (Auditd)        | `/var/log/audit/audit.log`            | `type=SYSCALL... syscall=openat... key=critical_config`                  | 重要ファイルへのアクセス監視   | auditdルール設定とLIルールの連携が必要             |
| カスタム         | NodeJS - Uncaught Exception                  | アプリケーションログファイル        | `"UncaughtException:"`, `"FATAL ERROR"`                                    | アプリケーションの致命的エラー検知 | ログ形式に合わせたパターン定義が必要                 |
| カスタム         | NodeJS - Unhandled Rejection                 | アプリケーションログファイル        | `"UnhandledPromiseRejectionWarning:"`                                    | 非同期処理エラーの検知       | ログ形式に合わせたパターン定義が必要                 |
| カスタム         | WebSocketApp - Authentication Failure        | アプリケーションログファイル        | `"WebSocket authentication failed for user:"`, `"Connection rejected from IP:"` | WebSocket認証失敗の検知      | アプリケーションログ実装依存                         |
| カスタム         | WebSocketApp - Input Validation Error        | アプリケーションログファイル        | `"Invalid input received:"`, `"Potential XSS attempt detected:"`         | 不正入力・攻撃試行の検知     | アプリケーションログ実装依存                         |
| カスタム         | WebSocketApp - Rate Limit Exceeded           | アプリケーションログファイル        | `"Rate limit exceeded for client:"`                                      | DoS攻撃やクライアント異常の検知 | アプリケーションログ実装依存                         |

## 侵入防御 (Intrusion Prevention - IPS) 推奨ルール

### 目的

侵入防御(IPS)機能は、ネットワークトラフィックを監視し、既知および未知の脆弱性を悪用しようとする攻撃シグネチャや異常な通信パターンを検知し、それらをブロック（Preventモード）またはログ記録（Detectモード）することを目的とします (8)。これにより、OS、ミドルウェア（Node.jsランタイム含む）、アプリケーションライブラリ、WebSocketプロトコル自体を標的とするネットワークベースの攻撃からサーバーを保護します。一般的なWebアプリケーション攻撃（SQLインジェクション、クロスサイトスクリプティング、OSコマンドインジェクションなど）やサービス拒否(DoS)攻撃に対する防御も含まれます (13)。

### アプローチ

1.  **推奨設定スキャンの実行:** IPSルール選定においても、**推奨設定スキャンが最も重要なステップ**です (1)。スキャンは、OS (Amazon Linux 2023)、インストールされているソフトウェア（Node.js含む）、開いているポートなどを分析し、関連性の高い脆弱性に対応するIPSルールを推奨します (19)。
2.  **ルールカテゴリの有効化とルール更新:** Workload Securityは、数千にも及ぶ膨大な数のIPSルールを保有しており、新たな脆弱性に対応するため毎週のようにルールが追加・更新されています (20)。特定のNode.jsバージョンやWebSocketプロトコルに限定した静的なルールリストを提供することは現実的ではありません (5)。したがって、「漏らさず」保護するという要求に対しては、関連するルールカテゴリ（例: OS脆弱性、Webアプリケーション脆弱性、アプリケーション固有脆弱性など）を有効化し、推奨設定スキャンの結果を適用し、そして最も重要なこととして、**Trend Microから提供されるルール更新を継続的に適用する運用プロセスを確立する**ことが、最も効果的かつ現実的なアプローチとなります。
3.  **CVEベースのルール適用:** Trend Microは、特定の**CVE（共通脆弱性識別子）**に対応するIPSルールをリリースすることがあります (21)。Node.js 22.13.1やその依存ライブラリに関連する新たな重大なCVEが公開された場合、Workload Securityのルールアップデートを通じて対応ルールが提供される可能性が高いです。利用者は、Node.jsや関連コンポーネントの脆弱性情報を定期的に確認し、対応するIPSルールが利用可能になった際には速やかに適用を検討する必要があります。
4.  **カスタムルールとサポート:** アプリケーション固有の脆弱性（カスタムコード内の問題など）が脆弱性スキャナ（Nessus, Qualysなど）で発見された場合、Trend Microのサポートに相談し、カスタムIPSルールの作成支援を受けることも選択肢となり得ます (20)。

### OSおよびWebサーバ共通の推奨ルール

Node.jsベースのWebSocketサーバーも、一般的なWebサーバーと同様の攻撃に晒される可能性があります。推奨設定スキャンの結果に加え、以下のカテゴリやタイプのルールが適用されていることを確認します。

#### OS脆弱性ルール:

* Amazon Linux 2023のカーネル、glibc、OpenSSL、OpenSSHなど、基盤となるOSコンポーネントの既知の脆弱性に対応するルール（推奨設定スキャンで提案されるはず）。

#### Webサーバー共通攻撃ルール:

* **SQLインジェクション:** アプリケーションがデータベースを利用する場合。例: ルールID `1000148` - Generic SQL Injection Prevention。
* **クロスサイトスクリプティング (XSS):** クライアントサイドでのスクリプト実行を防ぐ。例: ルールID `1000147` - Generic Cross-Site Scripting (XSS) Prevention。
* **OSコマンドインジェクション:** 外部からの入力がOSコマンドとして実行される脆弱性。例: ルールID `1005934` - Identified Suspicious Command Injection Attack (11)。
* **ディレクトリトラバーサル:** 不正なパス指定によるファイルアクセス。
* **ファイルインクルージョン (RFI/LFI):** 不正なファイルを読み込ませる攻撃。
* **HTTPプロトコル違反:** 不正な形式のHTTPリクエスト。
* **サービス拒否 (DoS/DDoS) 対策:** SYN Flood、Slowloris、大量リクエストなどに対応するルール（具体的なルールIDは要確認）。
* **その他:** サーバーサイドリクエストフォージェリ (SSRF)、XML外部実体参照 (XXE) など。

### Node.js 22.13.1 脆弱性対策ルール

現時点で、Node.js 22.13.1に特化したCVEに対応するWorkload SecurityのIPSルールが存在するかどうかは、Workload Securityコンソール内で直接確認する必要があります。提供された資料には、特定のNode.jsバージョンに対応するルールリストは含まれていませんでした (5)。

#### 推奨アプローチ:

* 推奨設定スキャンを実行し、Node.jsに関連するルールが推奨されるか確認します。
* Workload Securityのポリシー設定で、「侵入防御」>「一般」タブの「推奨設定の検索を継続的に実行」を有効にすることを検討します。
* IPSルールのリストで、「アプリケーションの種類」フィルタを使用し、「Node.js」に関連するアプリケーションタイプが存在するか確認し、関連ルールをレビューします。
* 「Web Application Security」、「Web Server Common」、「OS Vulnerabilities」などの関連カテゴリのルールを有効化します。
* Node.js公式やCVEデータベースでNode.js 22.13.1に関連する脆弱性情報を定期的に監視し、対応するIPSルールがTrend Microからリリースされた場合は適用します。
* Node.jsで発生しやすい汎用的な攻撃パターン（プロトタイプ汚染、非同期処理に起因する競合状態、特定のnpmパッケージの脆弱性など）に関連するルールが存在すれば適用を検討します（これらは通常、より広範なカテゴリに含まれる可能性があります）。

### WebSocket特有の攻撃対策ルール

WebSocketプロトコル自体を標的とした専用のIPSルールは限定的かもしれませんが、WebSocket通信上で発生しうる多くの攻撃は、既存のWebアプリケーション向けルールや汎用的なネットワーク攻撃対策ルールによって緩和できる可能性があります。

#### 考慮すべき攻撃と関連ルール:

* **クロスサイトWebSocketハイジャッキング (CSWH):** WebSocket接続確立時のオリジンチェック不備を悪用する攻撃。これは主にアプリケーション側の実装の問題ですが、不正なハンドシェイクリクエストパターンを検知するルール（HTTPプロトコル違反など）が役立つ可能性があります。
* **WebSocket経由のデータインジェクション:** WebSocketを通じてサーバーに送信されたデータが、サーバーサイドで適切にサニタイズ・バリデーションされずに処理されることで発生するXSS、SQLi、コマンドインジェクションなど。これらは前述のWebサーバー共通攻撃ルール（Generic XSS/SQLi/Command Injectionなど）で検知・防御できる可能性があります。
* **サービス拒否 (DoS):** 大量のWebSocket接続要求、不正な形式やサイズのメッセージ送信によるリソース枯渇攻撃。一般的なDoS対策ルール（SYN Floodなど）や、異常なトラフィック量・パターンを検知するルールが適用可能です。
* **プロトコルレベルの攻撃:** WebSocketハンドシェイクやフレームに関する仕様の悪用。HTTPプロトコル違反ルールや、より低レイヤーでの異常検知ルールが関連する可能性があります。

#### 推奨アプローチ:

* Webサーバー共通攻撃ルール（特にXSS, SQLi, コマンドインジェクション, DoS）を適用します。
* WebSocket通信が使用するポート（デフォルトはHTTP/HTTPSと同じだが、カスタムポートを使用している場合もある）が、Workload SecurityのIPS監視対象ポートに含まれていることを確認します。ポリシー設定の「設定」>「ネットワークエンジン」>「ポートリスト」で確認・編集できます。
* 必要に応じて、WebSocket通信に特有の異常パターン（例: 極端に大きなフレームサイズ、特定の不正な制御フレームなど）を検知するカスタムIPSルールの作成を検討します（ただし、これは高度な設定であり、誤検知のリスクも伴います）。

### 表3: 推奨侵入防御ルールリスト

IPSルールは膨大かつ動的であるため、完全なリスト提示は不可能です。以下の表は、適用を検討すべきルールカテゴリ、代表的なルール、およびNode.js/WebSocket環境で特に考慮すべき攻撃タイプとそれに対応するルール種別の例を示します。実際のルール適用は、**推奨設定スキャンの結果と継続的なルール更新**に基づいて行う必要があります。

| ルールID/カテゴリ      | ルール名/カテゴリ例                               | 防御対象・説明                                                            | 選定理由                       | 適用モード推奨 | 注意点                                                               |
| :--------------------- | :------------------------------------------------ | :------------------------------------------------------------------------ | :----------------------------- | :------------- | :------------------------------------------------------------------- |
| 推奨スキャン結果       | (スキャン結果に基づくルール)                    | OS、インストール済みソフトウェアに基づく脆弱性                              | 環境に合わせた最適化           | Prevent/Detect | スキャン結果を最優先で評価・適用                                     |
| `1000148` (例)         | Generic SQL Injection Prevention                  | SQLインジェクション攻撃                                                   | Webアプリケーションの共通脆弱性対策 | Prevent        | アプリケーションがDBを利用する場合                                   |
| `1000147` (例)         | Generic Cross-Site Scripting (XSS) Prevention     | クロスサイトスクリプティング攻撃                                          | Webアプリケーションの共通脆弱性対策 | Prevent        |                                                                      |
| `1005934` (例)         | Identified Suspicious Command Injection Attack    | OSコマンドインジェクション攻撃                                            | Webアプリケーションの共通脆弱性対策 | Prevent        |                                                                      |
| カテゴリ               | Web Server Common                                 | ディレクトリトラバーサル, RFI/LFI, HTTP違反など                           | Webサーバー/アプリケーションの基盤保護 | Prevent/Detect | 推奨スキャン結果と合わせて有効化                                     |
| カテゴリ               | OS Vulnerabilities (Linux)                        | カーネル、glibc、OpenSSLなどのOSコンポーネント脆弱性                        | OS基盤の保護                   | Prevent        | 推奨スキャン結果と合わせて有効化                                     |
| カテゴリ/要確認        | Application Vulnerabilities (Node.js)             | Node.jsランタイムや主要npmパッケージの既知脆弱性 (CVE)                    | アプリケーション実行環境の保護   | Prevent/Detect | ルール更新を継続的に確認、新規CVEに対応                              |
| カテゴリ               | Denial of Service (DoS)                           | SYN Flood, Slowloris, 大量リクエストなど                                  | サービスの可用性維持           | Prevent/Detect | 環境に合わせてしきい値等のチューニングが必要な場合あり               |
| (関連ルール適用)       | WebSocket経由のインジェクション                   | WebSocketを通じたXSS, SQLi, コマンドインジェクション                      | WebSocket通信経路からの攻撃対策 | Prevent        | GenericルールやWeb共通ルールが適用される                               |
| (関連ルール適用)       | クロスサイトWebSocketハイジャッキング (CSWH) 試行 | 不正なオリジンからのハンドシェイク試行など                                | WebSocket接続の乗っ取り試行対策 | Detect/Prevent | HTTPプロトコル違反ルール等が関連する可能性。アプリ側対策も重要         |

## 結論と今後のステップ

### 推奨事項の要約

Amazon Linux 2023上のNode.js WebSocketサーバーをWorkload Securityで効果的に保護するためには、以下のステップと設定が推奨されます。

1.  **最新バージョンの利用:** Workload Security ManagerおよびAgentが、Amazon Linux 2023をサポートするバージョン（Agent: **20.0.0-7303以降**, Manager: **20.0.789以降**）であることを確認します (1)。
2.  **推奨設定スキャンの活用:** Node.js WebSocketサーバーが稼働しているインスタンスに対して推奨設定スキャンを実行し、その結果をIM, LI, IPSルールの初期設定のベースラインとして適用します (1)。
3.  **変更監視 (IM) の強化:** 推奨ルールに加え、Linuxの重要なシステムディレクトリ（`/etc/`, `/bin/`, `/sbin/`, `/usr/bin/`, `/usr/sbin/`など）およびNode.jsアプリケーション固有のファイル（実行ファイル、`package.json`, アプリケーションコード、設定ファイル）を監視対象とするカスタムIMルールを設定します。`node_modules`の監視は慎重に行います（表1参照）。
4.  **セキュリティログ監視 (LI) の強化:** 推奨ルールに加え、Linuxの標準的なセキュリティログ（`/var/log/secure`, `/var/log/messages`, `/var/log/audit/audit.log`など）における重要イベント（ログイン失敗、特権昇格、サービスエラーなど）と、Node.jsアプリケーションおよびWebSocketサーバーが出力する固有のログ（エラー、認証イベント、入力検証違反など）を監視するためのカスタムLIルールを設定します（表2参照）。アプリケーションログの監視は、ログ実装との連携が鍵となります。
5.  **侵入防御 (IPS) の網羅的適用と維持:** 推奨設定スキャンの結果を適用し、OS脆弱性、Webサーバー共通攻撃、関連するアプリケーション脆弱性カテゴリのルールを有効化します。特に、Node.jsやWebSocketに関連する脆弱性情報は継続的に監視し、対応するルールがリリースされ次第適用します。WebSocket通信が使用するポートもIPSの監視対象に含めます。静的なリストに頼るのではなく、**継続的なルール更新プロセスが不可欠**です（表3参照）。
6.  **パフォーマンスと誤検知の管理:** ルール適用は段階的に行い、特に影響の大きいルールやカスタムルールは、まず**Detectモード**で評価し、必要に応じてチューニングを行います (8)。

### 継続的な監視とルール更新の重要性

本レポートで提示したルールは、現時点でのベストプラクティスと利用可能な情報に基づいた推奨事項です。しかし、サイバーセキュリティの脅威ランドスケープは絶えず変化しており、新たな脆弱性が日々発見されています。したがって、一度設定を完了した後も、以下の活動を継続的に実施することが、セキュリティ体制を維持・向上させる上で極めて重要です。

* **ルール更新の適用:** Trend Microから提供されるセキュリティアップデート（特にIPSルール）を定期的に確認し、速やかに適用します (20)。
* **定期的な推奨設定スキャン:** システム構成やアプリケーションの変更に合わせて、定期的に推奨設定スキャンを再実行し、ルールの見直しを行います。
* **ログとアラートの監視:** Workload Securityが生成するイベントログやアラートを日常的に監視し、インシデントの兆候がないか確認します。SIEMなどのログ管理システムとの連携も有効です (8)。

* **ルールのチューニング:** 運用を通じて得られた知見に基づき、誤検知を削減し、パフォーマンスを最適化するために、ルール設定（除外設定、しきい値、監視対象など）を継続的に見直し、調整します。
* **脆弱性情報の収集:** Node.js、利用しているnpmパッケージ、および基盤となるOSに関する脆弱性情報（CVE）を積極的に収集し、パッチ適用や、対応するWorkload Securityルールの適用を計画的に実施します。

これらの継続的な取り組みを通じて、Amazon Linux 2023上で稼働するNode.js WebSocketサーバーに対する堅牢なセキュリティ体制を構築・維持することが可能となります。
